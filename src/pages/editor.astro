---
import Layout from '../layouts/BlogPost.astro';
---

<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Blog Editor</title>
		<link rel="stylesheet" href="https://unpkg.com/vditor/dist/index.css" />
		<script src="https://unpkg.com/vditor/dist/index.min.js" is:inline></script>
		<style>
			body {
				font-family: system-ui, -apple-system, sans-serif;
				padding: 2rem;
				max-width: 1200px;
				margin: 0 auto;
				background-color: #f4f4f5;
			}
			.container {
				background: white;
				padding: 2rem;
				border-radius: 8px;
				box-shadow: 0 2px 4px rgba(0,0,0,0.1);
			}
			.form-group {
				margin-bottom: 1rem;
			}
			label {
				display: block;
				margin-bottom: 0.5rem;
				font-weight: bold;
			}
			input, textarea {
				width: 100%;
				padding: 0.5rem;
				border: 1px solid #ccc;
				border-radius: 4px;
				font-size: 1rem;
			}
			button {
				background-color: #0070f3;
				color: white;
				border: none;
				padding: 0.75rem 1.5rem;
				border-radius: 4px;
				cursor: pointer;
				font-size: 1rem;
				margin-top: 1rem;
			}
			button:hover {
				background-color: #0051a2;
			}
			#vditor {
				margin-top: 1rem;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<h1>Blog Editor</h1>
			
			<div class="form-group">
				<label for="title">Title</label>
				<input type="text" id="title" placeholder="Enter post title" />
			</div>

			<div class="form-group">
				<label for="slug">Slug (Filename)</label>
				<input type="text" id="slug" placeholder="my-new-post" />
			</div>

			<div class="form-group">
				<label for="description">Description</label>
				<textarea id="description" rows="3" placeholder="Enter post description"></textarea>
			</div>

			<div class="form-group">
				<label for="pubDate">Publish Date</label>
				<input type="date" id="pubDate" />
			</div>

			<div class="form-group">
				<label for="heroImage">Hero Image URL (Optional)</label>
				<input type="text" id="heroImage" placeholder="/blog-placeholder-1.jpg" />
			</div>

			<div class="form-group">
				<label>Content</label>
				<div id="vditor"></div>
			</div>

			<button id="saveBtn">Save Post</button>
		</div>

		<script>
			// Initialize date input with today
			const today = new Date().toISOString().split('T')[0];
			document.getElementById('pubDate').value = today;

			// Auto-generate slug from title
			document.getElementById('title').addEventListener('input', (e) => {
				const title = e.target.value;
				const slug = title
					.toLowerCase()
					.replace(/[^a-z0-9]+/g, '-')
					.replace(/(^-|-$)/g, '');
				
				// Only update slug if it hasn't been manually edited (simple check)
				// Or just let user edit it.
				if (!document.getElementById('slug').dataset.manuallyEdited) {
					document.getElementById('slug').value = slug;
				}
			});

			document.getElementById('slug').addEventListener('input', () => {
				document.getElementById('slug').dataset.manuallyEdited = 'true';
			});

			// Initialize Vditor
			let vditor;
			
			window.onload = () => {
				vditor = new Vditor('vditor', {
					height: 600,
					mode: 'sv', // split view
					cache: {
						enable: false,
					},
					upload: {
						url: '/api/upload-image',
						accept: 'image/*',
						filename: (name) => name.replace(/[^\w.]/g, '_'),
						fieldName: 'file',
						error: (msg) => {
							alert('Upload failed: ' + msg);
						}
					}
				});
			};

			// Save logic
			document.getElementById('saveBtn').addEventListener('click', async () => {
				const title = document.getElementById('title').value;
				const slug = document.getElementById('slug').value;
				const description = document.getElementById('description').value;
				const pubDate = document.getElementById('pubDate').value;
				const heroImage = document.getElementById('heroImage').value;
				const content = vditor.getValue();

				if (!title || !slug) {
					alert('Title and Slug are required!');
					return;
				}

				try {
					const response = await fetch('/api/save-post', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
						},
						body: JSON.stringify({
							title,
							slug,
							description,
							pubDate,
							heroImage,
							content
						}),
					});

					if (response.ok) {
						alert('Post saved successfully!');
					} else {
						const err = await response.text();
						alert('Error saving post: ' + err);
					}
				} catch (e) {
					console.error(e);
					alert('Error saving post: ' + e.message);
				}
			});
		</script>
	</body>
</html>
